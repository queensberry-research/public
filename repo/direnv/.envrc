#!/usr/bin/env sh
# shellcheck disable=SC1090

# echo
echo_date() { echo "[$(date +'%Y-%m-%d %H:%M:%S')] $*" >&2; }

# age
export AGE_RECIPIENT='age1wtv7d6qtzl43a6vgc0ahr3esk349t40szdyysu0cd84uvxm0e33sgksukd'

# pytest
export PY_COLORS='1'

# uv
export UV_INDEX='http://pypi'
export UV_MANAGED_PYTHON='true'
export UV_PRERELEASE='disallow'
export UV_PYTHON='3.13'
activate='.venv/bin/activate'
if [ -f "$activate" ]; then
	. "$activate"
else
	if command -v uv >/dev/null 2>&1; then
		uv venv
	else
		echo_date "ERROR: 'uv' is needed to create the virtual environment"
	fi
fi
if command -v uv >/dev/null 2>&1; then
	uv sync --all-extras --active --locked
else
	echo_date "ERROR: 'uv' is needed to synchronize the virtual environment"
fi

# subnet
if [ -n "$SUBNET" ]; then
	echo_date "SUBNET=$SUBNET is already defined"
else
	current_ip=$(ip route get 1.1.1.1 2>/dev/null | grep -oP '(?<=src\s)\d+(\.\d+){3}')
	if [ -z "$current_ip" ]; then
		echo_date "ERROR: 'SUBNET' is undefined, but we are unable to determine it since we are unable to determine the current IP"
	else
		current_subnet=$(echo "$current_ip" | cut -d. -f3)
		if ! command -v yq >/dev/null 2>&1; then
			echo_date "ERROR: 'SUBNET' is undefined, but we are unable to determine it since 'yq' is needed to read 'config.toml'"
		elif ! [ -f config.toml ]; then
			echo_date "ERROR: 'SUBNET' is undefined, but we are unable to determine it since we are unable to find 'config.toml'"
		else
			main_subnet=$(yq .network.vlan.main config.toml)
			test_subnet=$(yq .network.vlan.test config.toml)
			if [ "$current_subnet" = "$main_subnet" ]; then
				echo_date "Exporting SUBNET='main' since the current IP is $current_ip"
				export SUBNET='main'
			elif [ "$current_subnet" = "$test_subnet" ]; then
				echo_date "Exporting SUBNET='test' since the current IP is $current_ip"
				export SUBNET='test'
			else
				echo_date "ERROR: 'SUBNET' is undefined, but we are unable to determine it since the current IP $current_ip matches neither 'main' ($main_subnet) nor 'test' ($test_subnet); got '$current_subnet'"
			fi
		fi
	fi
fi
